#!/bin/bash

# Check for yay
if command -v yay >/dev/null 2>&1; then
    echo -e "yay was located, moving on.\n"
    yay -Suy
else
    echo -e "yay was not located. Installing yay...\n"
    
    git clone https://aur.archlinux.org/yay.git
    sudo chown -R $(whoami):$(whoami) yay
    (cd yay && makepkg -si)
    yay -Suy
fi

# Install base dependencies
sudo pacman -Syu sddm sddm-kcm layer-shell-qt5 qt5-declarative neofetch libva xorg-xinit xorg-server mesa pulseaudio nano flatpak

# Install SDDM theme
git clone https://github.com/HyDE-Project/sddm-hyprland
sudo make -C sddm-hyprland install

# Install CPU microcode
read -n1 -rep 'What is your CPU brand? (AMD: "a", Intel: "i", Other: "o")' CPU
if [[ $CPU == "A" || $CPU == "a" ]]; then
    echo -e "Installing AMD CPU microcode.\n"
    sudo pacman -Syu amd-ucode
elif [[ $CPU == "I" || $CPU == "i" ]]; then
    echo -e "Installing Intel CPU microcode.\n"
    sudo pacman -Syu intel-ucode
fi

# Install GPU drivers
read -n1 -rep 'What is your GPU brand? (AMD: "a", Intel: "i", NVIDIA: "n")' GPU
if [[ $GPU == "A" || $GPU == "a" ]]; then
    echo -e "Installing AMD GPU drivers.\n"
    sudo pacman -Syu vulkan-radeon xfe86-video-amdgpu
elif [[ $GPU == "I" || $GPU == "i" ]]; then
    echo -e "Installing Intel GPU drivers.\n"
    sudo pacman -Syu intel-media-driver libva-intel-driver intel-vulkan
elif [[ $GPU == "N" || $GPU == "n" ]]; then
    echo -e "Installing NVIDIA GPU drivers.\n"
    sudo pacman -Syu nvidia nvidia-utils nvidia-settings
fi

# Disable WiFi power save
read -n1 -rep 'Would you like to disable WiFi power save? (y/n) ' WIFI
if [[ $WIFI == "Y" || $WIFI == "y" ]]; then
    sudo tee /etc/NetworkManager/conf.d/wifi-powersave.conf > /dev/null <<EOF
[connection]
wifi.powersave = 2
EOF
    sudo systemctl restart NetworkManager
fi

# Install Hyprland packages
read -n1 -rep 'Would you like to install the required packages? (y/n) ' INST
if [[ $INST == "Y" || $INST == "y" ]]; then
    yay -S --noconfirm hyprland kitty waybar \
    swaybg swaylock-effects wofi wlogout mako thunar \
    ttf-jetbrains-mono-nerd noto-fonts-emoji \
    polkit-gnome python-requests starship \
    swappy grim slurp pamixer brightnessctl gvfs \
    bluez bluez-utils lxappearance xfce4-settings \
    dracula-gtk-theme dracula-icons-git xdg-desktop-portal-hyprland \
    firefox

    # Enable Bluetooth
    sudo systemctl enable --now bluetooth.service

    # Remove unnecessary portals
    yay -R --noconfirm xdg-desktop-portal-gnome xdg-desktop-portal-gtk
fi

# Copy config files
read -n1 -rep 'Would you like to copy config files? (y/n) ' CFG
if [[ $CFG == "Y" || $CFG == "y" ]]; then
    cp -R hypr kitty mako waybar swaylock wofi ~/.config/
    chmod +x ~/.config/waybar/scripts/waybar-wttr.py
fi

# Install Starship shell
read -n1 -rep 'Would you like to install the Starship shell? (y/n) ' STAR
if [[ $STAR == "Y" || $STAR == "y" ]]; then
    echo 'eval "$(starship init bash)"' >> ~/.bashrc
    cp starship.toml ~/.config/
fi

echo -e "Setup complete. Reboot and start Hyprland!"
